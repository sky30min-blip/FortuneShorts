name: Shorts Daily Upload & Comment Bot

on:
  schedule:
    # 매일 23:00 UTC = 한국시간 오전 8시
    - cron: "0 23 * * *"
    # 30분마다 댓글 봇
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  daily-upload:
    if: github.event.schedule == '0 23 * * *'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt google-api-python-client google-auth-oauthlib google-auth-httplib2

      - name: Write client_secrets.json
        run: |
          echo "$YOUTUBE_CLIENT_SECRETS_JSON" > client_secrets.json
        env:
          YOUTUBE_CLIENT_SECRETS_JSON: ${{ secrets.YOUTUBE_CLIENT_SECRETS_JSON }}

      - name: Write token.pickle
        run: |
          if [ -n "${{ secrets.YOUTUBE_TOKEN_PICKLE_B64 }}" ]; then
            echo "${{ secrets.YOUTUBE_TOKEN_PICKLE_B64 }}" | base64 -d > token.pickle
          fi

      - name: Run daily job
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python -m scripts.daily_job

  comment-bot:
    if: github.event.schedule == '*/30 * * * *'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt google-api-python-client google-auth-oauthlib google-auth-httplib2

      - name: Write client_secrets.json
        run: |
          echo "$YOUTUBE_CLIENT_SECRETS_JSON" > client_secrets.json
        env:
          YOUTUBE_CLIENT_SECRETS_JSON: ${{ secrets.YOUTUBE_CLIENT_SECRETS_JSON }}

      - name: Write token.pickle
        run: |
          if [ -n "${{ secrets.YOUTUBE_TOKEN_PICKLE_B64 }}" ]; then
            echo "${{ secrets.YOUTUBE_TOKEN_PICKLE_B64 }}" | base64 -d > token.pickle
          fi

      - name: Run comment responder
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          YOUTUBE_REPLY_VIDEO_ID: ${{ secrets.YOUTUBE_REPLY_VIDEO_ID }}
        run: |
          python -m modules.comment_responder
